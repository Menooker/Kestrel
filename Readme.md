# Kestrel - Transcribing and Translation subtitles of video and audio using Generative AI

Kestrel is a command line tool to use Gemini API of Google to make SRT subtitles from video and audio files. It is also able to translate a SRT file (no matter generated by Kestrel or not) to your language via Gemini API.

## Preparation

There are some preparation steps before using Kestrel.

### Getting Gemini API key

You can skip this step if you already have a Gemini API key.

Goto this [aistudio.google.com/app/apikey](aistudio.google.com/app/apikey) to apply for a Gemini API key. You can create a free-of-charge API key with limited resources.

### Installing Python SDK for Gemini

Python 3.9+ is required.

```bash
pip install google-generativeai
```

### Set up the proxy (optional)

If your shell environment cannot directly access Google services, remember to setup the proxy to make it accessible for Kestrel. For example, in Linux shell:

```bash
export http_proxy=http://....
export https_proxy=http://....
export HTTP_PROXY=http://....
export HTTPS_PROXY=http://....
```

In Powershell,

```powershell
$env:http_proxy="http://...."
$env:https_proxy="http://...."
$env:HTTP_PROXY="http://...."
$env:HTTPS_PROXY="http://...."
```

### Install ffmpeg

Kestrel depends on [ffmpeg](https://ffmpeg.org/) to extract and compress the audio. You can get binary of ffmpeg by following instructions on its [official page](https://ffmpeg.org/download.html). Windows and linux usesr can download the binary of ffmpeg at (BtbN/FFmpeg-Builds)[https://github.com/BtbN/FFmpeg-Builds/releases]. Usually a version of `ffmpeg-master-latest-???-gpl-shared` should work well.

## Transcribe media file to SRT subtitle

Run

```bash
python transcribe.py --path PATH/to/video/or/audio/file --ffmpeg PATH/to/ffmpeg/executable/file --key GEMINI_KEY [--segment SEGMENT] [--skip-transcribe] [--skip-extract] [--lang LANG]
```

In some systems, you may need to use `python3` in the above command.

Explanations of the options above:

 * `--path` - the path to the video or audio file. The current user should have write access to the parent directory of the path.
 * `--ffmpeg` - the executable file of ffmpeg. Usually somewhere like `ffmpeg-master-latest-win64-gpl-shared\bin\ffmpeg.exe` on windows.
 * `--key` - the Gemini API key.
 * `--segment` - optional segment time length in seconds, default=180. Kestrel cuts the audio into segments of that length and feed them one-by-one to Gemini.
 * `--lang` - optional output language in the file name, default=jp. The output language it **not** auto-detected. This option only affects the output file name.
 * `--skip-extract` - optionally resume the previous run by skipping both "extract" step (see below).
 * `--skip-transcribe` - optionally resume the previous run by skipping both "extract" and "transcribe" step (see below).

After successfully running the script, the subtitle file of the input media file will be generated at the same directory of the file. For example, if the input file is at `/home/1.mp4`, the output subtitle file will be at `/home/1.{lang}.srt`, where `{lang}` is the user-specified language given via `--lang` option.

The script will create a directory named `{mediafile}.{ext}.dir` in the directory of the media file, for a file named `{mediafile}.{ext}`. Kestrel will put the temp files in that directory. Users should manually delete that directory when the transcription is completed.

The files in this directory is also used by Kestrel to resume the progress from a previous run of the media file. To reset the progress and the states of that media file, users can delete the corresponding temp directory `{mediafile}.{ext}.dir`.

### Internal steps of transcribing the media file

To transcribe a media file, Kestrel does the following steps:

1. `extract-stage`: extract the audio from the media file, compress it in mp3 format, and segment the audio into a list of mp3 files. Temp files are `output_*.mp3`.
2. `upload-stage`: upload the mp3 segments to Google service. Temp file is `uri.txt`.
3. `transcribe-stage`: Use Gemini API to transcribe each of segments one-by-one. Temp file is `state.txt` and `raw.txt`.
4. `convert-stage`: Convert the result from Gemini into SRT files.

The `upload-stage` and `transcribe-stage` may take some time and are resumable.

### Resume from previous progress

You might meet errors like networking issues when Kestrel communicating with Google service. You can resume from the previous progress in these cases.

If `extract-stage` is complete (if you can see "Uploading" in the console output), you can re-run `transcribe.py` with the same command line with the additional option `--skip-extract`. Kestrel will first resume uploading and check if the uploaded files are still available in Google's server.

Note that Google only keeps the uploaded temp files in 48 hours, so you might see errors like "resource not found". In that case, you can remove the `uri.txt` and `state.txt` from the temp directory and retry the script with `--skip-extract`.

If all the files are already uploaded, Kestrel will resume from the proviously position of transcription.


## Translate existing SRT files

Run

```bash
python translate.py --base PATH/to/parent/dir/ --key GEMINI_KEY -l filename [-l filename2 -l filename3 ...] [--in-lang LANG] [--out-lang LANG] [--resume RESUME] [--batchsize BATCHSIZE] [--hint HINT]
```

 * `--base` - the **directory path** of the SRT file
 * `--key` - Gemini API key
 * `-l` or `--list` - the **filenames** of the SRT file. If multiple `-l` is passed, the script will translate a list of SRT files. For an SRT file named `111.zh-cn.srt`, you should pass `-l 111 --in-lang zh-cn` in the arguments
 * `--in-lang` - the language specifier of input SRT file. It should occur in the SRT file name. By default, `jp`. See above.
 * `--out-lang` - the language specifier of output SRT file. By default, `zh-cn`.
 * `--resume` - skip the first N conversations of the SRT file and start translation after them. Leave first N conversations untranslated and copy to the output.
 * `--batchsize` - optional. By default = 200. Specifies how many conversations in the SRT file should be sent to Gemini in a batch.
 * `--hint` - optional. additional hint/prompts to the model.

The output files are generated in `{base}/{filename}.{out-lang}.srt` for each file specified by `-l` or `--list`.
